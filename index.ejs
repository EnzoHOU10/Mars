<!DOCTYPE html>
<html>
  <head>
    <title>Weather</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
  </head>
  <header>
    <nav>
      <div class="logo">
        <a href="/">Mars</a>
      </div>
      <img src="../../logo_white.png" alt="logo" class="img-logo" />
      <div class="nav-buttons">
        <% if (isAuthenticated) { %>
          <button class="btn-nav" onclick="showAccount()">Account</button>
        <% } else { %>
          <button class="btn-nav" onclick="showChoose()">Sign In | Register</button>
        <% } %>
      </div>
    </nav>
  </header>
  <body>
    <div class="rotating-background"></div>
    <div id="modals">
      <div class="modal-overlay" id="overlay"></div>
        <% if (isAuthenticated) { %>
          <div class="modal" id="accountModal">
            <div class="account-container card">
              <button id="close-btn" class="btn-close" onclick="closeAll()">‚úñ</button>
              <div class="account-content">
                <h2>Welcome, <%= user.prenom_utilisateur %>!</h2>
                <p>Prenom: <%= user.prenom_utilisateur %></p>
                <p>Nom: <%= user.nom_utilisateur %></p>
                <p>Email: <%= user.email_utilisateur %></p><br/>
                <button onclick="toggleEdit()" class="btn">Edit Info</button><br/>
                <button onclick="logout()" class="btn">Log out</button>
              </div>
      
              <!-- Edit Info Card -->
              <div id="editCard" style="display:none;">
                <h2>Edit Your Information</h2>
                <input type="text" placeholder="Pr√©nom" />
                <input type="text" placeholder="Nom" />
                <input type="email" placeholder="Email" />
                <input type="password" placeholder="Nouveau mot de passe (optionnel)" />
                <button class="btn">Submit</button>
              </div>
            </div>
          </div>
        <% } else { %>
          <div class="modal" id="chooseModal">
            <div class="card">
              <button id="close-btn" class="btn-close" onclick="closeAll()">‚úñ</button>
              <h2>Account</h2>
              <button onclick="showLogin()" class="btn-nav">Sign in</button><br/>
              <button onclick="showRegister()" class="btn-nav">Register</button>
            </div>
          </div>
        <% } %>
        <div class="modal" id="loginModal">
          <div class="card">
            <button id="close-btn" class="btn-close" onclick="closeAll()">‚úñ</button>
            <h2>Bienvenue</h2>
            <p>Connectez-vous √† votre compte</p>
            <img src="../img/unknown.jpg" class="login-image" />
            <form onsubmit="handleLogin(event)">
              <input id="login-email" type="email" placeholder="Email" required />
              <input id="login-mdp" type="password" placeholder="Mot de passe" required />
              <input class="btn-submit" type="submit" value="Se connecter" />
              <p class="register-link">Pas encore de compte ? <a href="#" onclick="showRegister()">Inscrivez-vous</a></p>
            </form>
          </div>
        </div>
        <div class="modal" id="registerModal">
          <div class="card">
            <button id="close-btn" class="btn-close" onclick="closeAll()">‚úñ</button>
            <h2>Cr√©er un compte</h2>
            <p>Inscrivez-vous pour acc√©der √† nos services</p>
            <img src="../img/unknown.jpg" class="register-image" />
            <form onsubmit="handleRegister(event)">
              <input id="register-prenom" type="text" placeholder="Pr√©nom" required />
              <input id="register-nom" type="text" placeholder="Nom" required />
              <input id="register-email" type="email" placeholder="Email" required />
              <input id="register-mdp" type="password" placeholder="Mot de passe" required />
              <input type="submit" value="S'inscrire" class="btn-submit" />
              <p class="login-link">Vous avez d√©j√† un compte ? <a href="#" onclick="showLogin()">Connectez-vous</a></p>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="info-page">
    
      <!-- Section des mini cartes en haut -->
      <div class="info-summary">
        <% weathers.forEach(function(weather, index) { %>
          <div class="summary-card" onclick="showDetails('<%= index %>')">
            <h2>Jour <%= weather.sol %></h2>
            <p>Temp√©rature moyenne: <%= weather.temperature.av %>¬∞C</p>
            <p>Temp√©rature min: <%= weather.temperature.mn %>¬∞C</p>
            <p>Temp√©rature max: <%= weather.temperature.mx %>¬∞C</p>
            <% if (weather.temperature.av > 0) { %>
              <img src="/img/weather/sun.png" alt="Weather" />
            <% } else { %>
              <img src="/img/weather/snow.png" alt="Weather" />
            <% } %>
          </div>
        <% }); %>
      </div>
    
      <!-- Section de la carte horizontale avec les d√©tails -->
      <div class="slider-container">
        <% weathers.forEach(function(weather, index) { %>
          <div class="slider-card" id="card-<%= index %>" style="display: none; width: 80%;">
            <h2>Jour <%= weather.sol %> - D√©tails</h2>
      
            <div class="columns-wrapper">
              <div class="column">
                <p><strong>üå°Ô∏èTemp√©rature</strong></p>
                <p>Min: <%= weather.temperature.mn %> ¬∞C</p>
                <p>Max: <%= weather.temperature.mx %> ¬∞C</p>
                <p>Moyenne: <%= weather.temperature.av %> ¬∞C</p>
              </div>
              <div class="column">
                <p><strong>üí®Vent</strong></p>
                <p>Min: <%= weather.pressure?.mn ?? "N/A" %> m/s</p>
                <p>Max: <%= weather.pressure?.mx ?? "N/A" %> m/s</p>
                <p>Moyenne: <%= weather.pressure?.av ?? "N/A" %> m/s</p>
              </div>
              <div class="column">
                <p><strong>üí•Pression</strong></p>
                <p>Min: <%= weather.windSpeed?.mn ?? "N/A" %> Pa</p>
                <p>Max: <%= weather.windSpeed?.mx ?? "N/A" %> Pa</p>
                <p>Moyenne: <%= weather.windSpeed?.av ?? "N/A" %> Pa</p>
              </div>
            </div>
          </div>
          <div class="slider-card" id="card-<%= index %>-bis" style="display: none; width: 20%;">
              <div>
                <p><strong>Saison</strong></p>
                <p><%= weather.season %></p>
              </div>
              <div>
                <p><strong>firstUTC</strong></p>
                <p><%= weather.firstUTC %></p>
              </div>
              <div>
                <p><strong>lastUTC</strong></p>
                <p><%= weather.lastUTC %></p>
              </div>
          </div>
        <% }); %>
      </div>
      
    </div>
    
  </body>
  <script>
    
    //const background = document.querySelector('.rotating-background');
    //window.addEventListener('scroll', () => {
      //const rotation = window.scrollY * 0.05;
      //background.style.transform = `rotate(${rotation}deg)`;
    //});
    // Fonction pour afficher les d√©tails d'une carte s√©lectionn√©e
    function showDetails(index) {
      const allCards = document.querySelectorAll('.slider-card');
      allCards.forEach(card => {
        card.style.display = 'none';
      });
      const selectedCard = document.getElementById(`card-${index}`);
      selectedCard.style.display = 'block';
      const selectedCardbis = document.getElementById(`card-${index}-bis`);
      selectedCardbis.style.display = 'block';
    }

    const overlay = document.getElementById('overlay');
    const modals = {
      account: document.getElementById('accountModal'),
      choose: document.getElementById('chooseModal'),
      login: document.getElementById('loginModal'),
      register: document.getElementById('registerModal'),
      overlay: document.getElementById('overlay'),
    };

    function toggleModal() {
      overlay.classList.toggle('show');
      Object.values(modals).forEach(modal => modal?.classList.remove('show'));
    }

    function showLogin() {
      toggleModal();
      modals.login.classList.add('show');
      modals.overlay.classList.add('show');
    }

    function showRegister() {
      toggleModal();
      modals.register.classList.add('show');
      modals.overlay.classList.add('show');
    }
    
    function showAccount() {
      toggleModal();
      modals.account.classList.add('show');
      modals.overlay.classList.add('show');
    }

    function showChoose() {
      toggleModal();
      modals.choose.classList.add('show');
      modals.overlay.classList.add('show');
    }



    function closeAll() {
      overlay.classList.remove('show');
      Object.values(modals).forEach(modal => modal?.classList.remove('show'));
    }

    function toggleEdit() {
      const edit = document.getElementById('editCard');
      if (edit) edit.style.display = (edit.style.display === 'none' ? 'block' : 'none');
    }

    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById("login-email").value;
      const mdp = document.getElementById("login-mdp").value;
      try {
        const response = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email_utilisateur: email, mdp_utilisateur: mdp }),
        });
        if (!response.ok) {
          alert("Email ou mot de passe incorrect");
          return;
        }
        location.reload();
      } catch (error) {
        console.error("Erreur login:", error);
        alert("Erreur de connexion");
      }
    }

    async function handleRegister(event) {
      event.preventDefault();
      const prenom = document.getElementById("register-prenom").value;
      const nom = document.getElementById("register-nom").value;
      const email = document.getElementById("register-email").value;
      const mdp = document.getElementById("register-mdp").value;
      try {
        const response = await fetch("/api/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prenom_utilisateur: prenom,
            nom_utilisateur: nom,
            email_utilisateur: email,
            mdp_utilisateur: mdp,
          }),
        });

        if (!response.ok) {
          alert("Erreur lors de l'inscription");
          return;
        }
        location.reload();
      } catch (error) {
        console.error("Erreur inscription:", error);
        alert("Erreur d'inscription");
      }
    }

    async function modify() {
      const prenom = document.getElementById("modify-prenom").value;
      const nom = document.getElementById("modify-nom").value;
      const email = document.getElementById("modify-email").value;
      const mdp = document.getElementById("modify-mdp").value;
      try {
        const response = await fetch(`/api/utilisateur`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prenom_utilisateur: prenom,
            nom_utilisateur: nom,
            email_utilisateur: email,
            mdp_utilisateur: mdp,
          }),
        });
        if (!response.ok) {
          alert("Erreur lors de la modification");
          return;
        }
        location.reload();
      } catch (error) {
        console.error("Erreur modification:", error);
        alert("Erreur lors de la modification");
      }
    }

    async function logout() {
      try {
        const response = await fetch("/api/auth/logout", {
          method: "POST",
        });
        if (!response.ok) {
          throw new Error("Erreur lors de la d√©connexion");
        }
        location.reload();
      } catch (error) {
        console.error("Erreur logout:", error);
        alert("Erreur lors de la d√©connexion");
      }
    }
    
  </script>
  
</html>
