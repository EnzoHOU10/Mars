const express=require("express"),cors=require("cors"),dotenv=require("dotenv"),app=express(),API_KEY="DEMO_KEY",API_URL=`https://api.nasa.gov/insight_weather/?api_key=${API_KEY}&feedtype=json&ver=1.0`,PORT=3e3,session=require("express-session"),path=require("path"),fetch=require("node-fetch"),compression=require("compression");let totalRequests=0,totalResponseTime=0,responseCount=0;app.use(((e,s,t)=>{totalRequests++;const r=Date.now();s.on("finish",(()=>{const e=Date.now()-r;totalResponseTime+=e,responseCount++})),t()})),app.locals.analytics={getTotalRequests:()=>totalRequests,getAverageLoadTime:()=>responseCount>0?(totalResponseTime/responseCount/1e3).toFixed(2):0},dotenv.config();const authRoutes=require("./router/auth.min.js"),userRoutes=require("./router/utilisateur.min.js"),analyticsRoutes=require("./router/analytics.min.js");app.set("view engine","ejs"),app.use(compression({brotli:{enabled:!0,zlib:require("zlib")},level:6})),app.use(cors()),app.use(express.json()),app.use(express.urlencoded({extended:!0})),app.use(express.static("public",{maxAge:"1d"})),app.use(session({secret:"vvs",resave:!1,saveUninitialized:!0})),app.use("/api/auth",authRoutes),app.use("/api/utilisateur",userRoutes),app.use("/api/analytics",analyticsRoutes);let marsWeatherCache=null,cacheExpiration=null;app.get("/",(async(e,s)=>{try{const t=Date.now();if(s.set("Cache-Control","public, max-age=600"),marsWeatherCache&&cacheExpiration>t)return console.log("Données récupérées depuis le cache"),s.render("index.ejs",{title:"Home",message:"Welcome to the Home Page!",weathers:marsWeatherCache,isAuthenticated:!!e.session.user,user:e.session.user||null,showLogin:!1,showRegister:!1,isHidden:!0});const r=await fetch(API_URL),a=await r.json(),o=(a.sol_keys||[]).map((e=>{const s=a[e];return{sol:e,temperature:s.AT||null,pressure:s.PRE||null,windSpeed:s.HWS||null,windDirection:s.WD?.most_common||null,season:s.Season||null,firstUTC:s.First_UTC||null,lastUTC:s.Last_UTC||null}}));marsWeatherCache=o,cacheExpiration=t+432e5,s.render("index.ejs",{title:"Home",message:"Welcome to the Home Page!",weathers:o,isAuthenticated:!!e.session.user,user:e.session.user||null,showLogin:!1,showRegister:!1,isHidden:!0})}catch(e){console.error("Erreur lors de la récupération des données météo de Mars :",e.message),s.status(500).json({error:"Erreur lors de la récupération des données météo de Mars."})}})),app.get("/analytics",(async(e,s)=>{try{const t=await fetch("http://localhost:3000/api/analytics"),r=await t.json(),a=e.session.user||null,o=!!a;s.render("analytics.ejs",{analytics:r,isAuthenticated:o,user:a,showLogin:!1,showRegister:!1,isHidden:!0})}catch(e){console.error("Erreur lors de la récupération des données analytics:",e),s.status(500).json({error:"Erreur serveur"})}})),app.get("/dashboard",((e,s)=>{const t=e.session.user||null,r=!!t;s.render("dashboard.ejs",{isAuthenticated:r,user:t,showLogin:!1,showRegister:!1,isHidden:!0})})),app.listen(3e3,(()=>{console.log("Serveur backend démarré sur http://localhost:3000/")}));